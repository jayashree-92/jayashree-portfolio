# jayashree-portfolio
Terraform-CI
Order

Steps

Description

1

Install SSH Keys

Recover SSH key and Known Hosts from Azure Pipeline Library Secure Files to be able to download remote Terraform-Modules from a different private repository. Those files can be generated by a user or service account within Azure DevOps.

2

Terraform Init

Run a “terraform init” from remote state files provided by the pipeline.

3

Terraform Validate

Run a “terraform validate” to test code structure only.

 

Terraform-CD
This step is run by environment (PROD, QA…etc)

Order

Steps

Description

1

Install SSH Keys

Recover SSH key and Known Hosts from Azure Pipeline Library Secure Files to be able to download remote Terraform-Modules from a different private repository. Those files can be generated by a user or service account within Azure DevOps.

2

Terraform Init

Run a “terraform init” from remote state files provided by the pipeline.

3

Terraform Workspace

Run a “terraform workspace select <ENV> to select the correct environment. This information is a parameter from the pipeline configuration.

4

Terraform Plan

Run a “terraform plan” to generate a terraform plan. This plan will be exported as a file and packaged in an artifact for the deployment in the next steps.

5

Generate Artifact

Generate an artifact with the terraform plan exported in the previous step.

6

Manual Validation

This step will pause the pipeline to let the operator check the terraform plan before proceeding with the deployment. An email will be sent, and you can acknowledge or not the deployment in the pipeline itself. If this step timeout after the given period, the deployment will not be executed.

7

Download Artifact

Download the artifact containing the terraform plan generated in the previous steps. 

8

Terraform Workspace

Run a “terraform workspace select <ENV> to select the correct environment. This information is a parameter from the pipeline configuration.

9

Terraform Apply

Run a “terraform apply” from the downloaded plan in the previous step. This will start the deployment / modification / destroy of the resources according to the plan.

 

To configure the pipeline to use the self-hosted agent of DevOps:

1- Change the yml main file section:

    pool:
       name: "terraform-pipeline-cu"
   (Previously vmImage: ubuntu-latest)

2- go in templates/terraform-env-deploy.yml, then add this under terraform_apply job :

        timeoutInMinutes: 0

         (Just under displayName: Terraform Apply)

 

Sequence of actions
Give Key Vault access to the AD registered application launching the pipeline.

Create all AD service accounts and reference them in the Key Vault and in Terraform variable file (see requirements for service accounts)

Be sure the computer object for WSFC in AD is disabled.

Create required GPO and AD groups if needed.

Check if you have enough quotas in your subscription to deploy virtual machines.

Be sure not computer objects with same names already exist in AD.

Create and fill the Terraform variable file. 

In the variable file, keep the “enable_wsfc_join” to “false” if you deploy for the first time. This will allow you to run a check to the servers before deploying the WSFC configuration.

Launch the Azure DevOps pipeline. be sure to select the right environment in “Stages to run” section.

After successfully run the pipeline, do those checks and actions:

Add created AD computers objects to the right group of GPO

Reboot computers at least one time to be sure all GPO are affected.

Double-check that SQL Services still running.

Be sure that WinRM is working, and you can enter sessions remotely between the nodes

Make sure DNS resolution is working between the nodes.

Set the “enable_wsfc_join” to “true“ in the code and launch the pipeline again. This will launch ARM deployments in the resource group. 

Once all ARM deployments are successful, validate that you can connect to the cluster using the “Failover Cluster Management” MMC, then ensure all nodes are joined and up.

By using SSMS, create and deploy the SQL Availability Groups:

Create a database

Do a full backup of the database

Create the availability group using this procedure Configure availability group (Azure quickstart template) - SQL Server on Azure VMs 

Create the listeners using ARM templates in the project. There is a template file and parameters file, you can use both Azure Portal or command line to deploy.

Be sure to allow “NT Services\ALL SERVICES” and the SQL Service Account to run as a service on virtual machines all along the deployment process, or the WSFC join part will fail.

In case of re-deploying the SQL nodes, you can just delete the entire resource group in Azure and start over with the steps abo
